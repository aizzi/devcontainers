FROM ubuntu:22.04
ARG PYTHON_VERSION="3.12.1"
ARG PLANTUML_VERSION="1.2023.13"
ENV DEBIAN_FRONTEND noninteractive

# Install Ubuntu server
RUN apt-get update -y \
    && apt-get install -y --no-install-recommends ubuntu-server

# Install Python 3.12
# Instruction from https://stackoverflow.com/questions/75159821/installing-python-3-11-1-on-a-docker-container
RUN apt-get install -y --no-install-recommends apt-utils build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libreadline-dev libffi-dev libsqlite3-dev libbz2-dev pkg-config wget
RUN cd /usr/src \
    && wget https://www.python.org/ftp/python/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tgz \
    && tar -xzf Python-${PYTHON_VERSION}.tgz \
    && cd Python-${PYTHON_VERSION} \
    && ./configure --enable-optimizations \
    && make altinstall \
    && rm /usr/src/Python-${PYTHON_VERSION}.tgz
RUN update-alternatives --install /usr/bin/python python /usr/local/bin/python3.12 1

# Install pip and pipx
RUN apt-get install -y --no-install-recommends python3-pip pipx \
    && pipx ensurepath

# Install the environment to support plantuml diagrams
RUN apt-get install -y --no-install-recommends default-jre graphviz plantuml \
    && wget -O /usr/share/plantuml/plantuml.jar https://github.com/plantuml/plantuml/releases/download/v${PLANTUML_VERSION}/plantuml.jar

# Update and upgrade
RUN apt-get update -y \
    && apt-get upgrade -y

# Clean up
RUN apt-get purge -y imagemagick imagemagick-6-common \
    && apt-get clean

# Install poetry
ENV PATH /root/.local/bin:$PATH
RUN pipx install poetry==1.7.0 \
    && poetry completions bash >> ~/.bash_completion \
    && poetry self add "poetry-dynamic-versioning[plugin]"

